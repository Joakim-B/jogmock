## Notes
### android:networkSecurityConfig
By default android:networkSecurityConfig is equal to "@xml/network_security_config", and res/xml/network_security_config.xml looks like this:
```xml
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <debug-overrides>
        <trust-anchors>
            <certificates src="user" />
        </trust-anchors>
    </debug-overrides>
    <domain-config cleartextTrafficPermitted="true">
        <domain includeSubdomains="false">connect.garmin.com</domain>
        <domain includeSubdomains="false">10.0.2.2</domain>
        <domain includeSubdomains="true">seggie-internal.strava.com</domain>
    </domain-config>
</network-security-config>
```
Which allows us to simply set android:debuggable="true" in the manifest to enable user certificates.

### Certificate pinning
Certificate pinning is done through okhttp3's certificate pinner, which is why we can simply replace the SPKI hash for "cdn-1.strava.com" (which is used by the mobile app). To find the file where certificate pinning is enabled the bak-smali'd files can be grepped for "Lokhttp3/CertificatePinner$Builder;->add" and "cdn-1.strava.com" (must be in the same file). Then, the SPKI hash matching /"sha256/[a-zA-Z0-9/+=]+"/ needs to be replaced to the SPKI hash of the certificate generated by your proxy (e.g. burp suite).

### Recaptcha
Initialization can be located by searching for "$recaptchaKey" and "recaptcha_fallback". The site key should simply be one of the object fields, initialized with a constructor. The site key can only be used to complete recaptcha through

## Workflow of debugging traffic
1. Make sure you are using the latest apktool version (build from sources)
2. Download strava apk from APKMirror (https://www.apkmirror.com/?s=com.strava) or other site
3. Run `./prepare-apk.py {apk}` which will unpack the apk and prepare a local workspace.
4. Enable your proxy and get "cdn-1.strava.com"'s certificate signed by the proxy
5. Run `./get-spki.py {cert}` which will get the certificate's SPKI hash used for pinning
6. Run `./change-spki.py {unpacked-dir} {proxy-spki}` to replace the SPKI hash used for certificate pinning
7. Run `./build-apk.py {unpacked-dir}` to rebuild the apk with debug mode enabled.
8. Sign the apk using `keytool` and `apksigner`